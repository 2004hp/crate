.. highlight:: yaml
.. _crate_ami:

=============================================
Launching EC2 Instances with the Crate AMI
=============================================

Crate provides custom `AMI`_'s that can be launched from every
EC2 user by using the AWS Management Console or `AWS CLI`_. The naming
convention is as follows:

  ``Crate-AWS-AMI-<VERSION>-<REVISION>``

The placeholder ``<VERSION>`` is the Crate version in the *x.y.z* format and
``<REVISION>`` describes its build revision. The Crate AWS AMI is based on
the Amazon Linux (`Amazon Linux AMI`_ ``ami-a10897d6``) and comes with
Java 8 and Crate pre-installed.

Finding the Crate AMI
=====================

To launch an EC2 instance based on the Crate AMI, use the search panel to
find the image in the public AMI repository. After choosing the desired AMI
by its Crate version, it can be launched as an EC2 instance running on your
account.


.. image:: ../_static/crate-ami-search.png
   :alt: Search for public Crate AMI on AWS Management Console
   :width: 100%


If you are using the `AWS CLI`_ you can find the public Crate AMI by using the
``describe-images`` command. The easiest way to search for it is by using its
``AMI Name``. AMIs are listed in JSON-format and sorted by their creation date.
The following command lists every available Crate AMI on the AWS platform.

.. code-block:: bash

    $ aws ec2 describe-images --filters "Name=name,Values=Crate-AWS-AMI-*"


Launch the AMI
==============

You can launch one or more instances with the Crate AMI using the
``run-instances`` command utilizing the ``--image-id`` command line option.
You can use the parameters of the command to configure its start-up behavior
and hardware configuration. A valid key-pair is necessary to connect to the
instances later.

.. code-block:: bash

    $ aws ec2 run-instances --image-id <AMI-ID> --count <NR-OF-INSTANCES> --instance-type <INSTANCE-TYPE> --user-data <USER-DATA>  --key-name <KEY-NAME>

.. _cloud_init:

Cloud-Init
----------

The AMI creates a basic crate configuration at first launch (using
Cloud-Init). During startup the `Cloud-Init`_ process checks if ephemeral
devices are attached to the instance. If the device contains no filesystem
it will be formatted with the *ext4* file system. Otherwise the filesystem
already installed will be used. The mount point of each attached device is
defined as ``/mnt/<DEV-NAME>`` where ``<DEV-NAME>`` is the name of the
device as listed in ``/dev``. The configuration settings (defined in
``/etc/crate/crate.yml`` are listed below and include:

  * Mount ephemeral devices and set the crate data path on their mount points
    (:ref:`attached_devices`)
  * Enable *EC2 discovery*
  * Set node name to instance hostname

In addition to the preconfigured *Cloud-Init* setup, it is possible to inject
commands as a *User-Data* shell-script.

.. note::
    Note that *User-Data* scripts are called before the pre-installed *Cloud-Init*
    scripts and therefore the injected *User-Data* settings might be overridden
    by *Cloud-Init* (see :ref:`cloud_init`).

EC2 Discovery
-------------

The AMI uses *EC2 discovery* as a default unicast host discovery mechanism.
(see :ref:`ec2_setup`). You must provide Crate with your AWS credentials so
that it can authenticate requests on the EC2 API. You have to provide
these credentials (access key and secret key) as part of the *User-Data*
settings when launching the instance.

.. note::
    *EC2 discovery* is only available on Crate version 0.51.0 or higher.

.. code-block:: bash

    #!/bin/bash
    echo "
    export AWS_ACCESS_KEY_ID='<your_access_key_id>'
    export AWS_SECRET_ACCESS_KEY='<your_secret_access_key>'
    " >> /etc/sysconfig/crate


Adapt Crate Configuration
-------------------------

The Crate configuration file ``/etc/crate/crate.yml`` can be adapted on startup
by using the *User-Data* script (see :ref:`cloud_init`). The following example
shows how to set the ``minimum_master_nodes`` and gateway configuration setting
which are essential for a multi node setup (:ref:`multi_node_setup`). This
configuration is used when a cluster with 3 or more nodes is set up.

.. code-block:: bash

    #!/bin/bash
    echo "
    discovery.zen.minimum_master_nodes: 2
    " >> /etc/crate/crate.yml

    echo "
    gateway:
      recover_after_nodes: 3
      recover_after_time: 5m
      expected_nodes: 3
    " >> /etc/crate/crate.yml


Launch AMI by using the AWS CLI
-------------------------------

The following example shows how to run a single instance of type
``m3.medium`` and pass the AWS credentials as a file (provided as
``user-data.sh``).

.. code-block:: bash

    $ aws ec2 run-instances --image-id ami-544c1923 --count 1 --instance-type m3.medium --user-data $(base64 user-data.sh) --key-name my_key_pair


.. note::
    In case you want to filter machines by instance tags or security groups,
    add this configuration to the ``USER-DATA`` field parameter
    (see :ref:`filter-by-tags`).


Instance Types
==============

The instance type specifies the combination of CPU, memory, storage and
networking capacity. To receive better performance for running queries
select an instance type which gives the possibility to attach ephemeral
storage. On newer AWS instance types this storage is covered by
`Solid-State-Drives`_ (short *SSD*). By choosing one of those instance types
Crate will automatically mount and store its data on those devices if they are
attached to the instance as a block device mapping (see also :ref:`attached_devices`).
Instance Types with additional instance store volumes (SSD or HDD) are
currently all instances of type ``m3``, ``g2``, ``r3``, ``d2`` and ``i2``.

.. _attached_devices:

Attached Devices
================

To add a block device mapping before launching an instance, it is possible to
use the ``block-device-mappings`` parameter with the ``run-instances`` command.
In this case ``ephemeral1`` will be added as an instance store volume with the
device name ``/dev/sdc``.

.. code-block:: bash

    $ aws ec2 run-instances --image-id ami-544c1923 --count 1 --instance-type m3.medium --block-device-mappings "[{\"DeviceName\": \"/dev/sdc\",\"VirtualName\":\"ephemeral1\"}]"

.. note::
    Note that the data stored on ephemeral disks is nor permanent and only
    persists during the lifetime of an instance.

If no block device mapping is configured on the EC2 instance, the default data
directory of Crate is set to ``/var/lib/crate``. The data paths are set in
``/etc/crate/crate.yml``.

.. _AMI: https://en.wikipedia.org/wiki/Amazon_Machine_Image
.. _Solid-State-Drives: https://en.wikipedia.org/wiki/Solid-state_drive
.. _AWS CLI: https://aws.amazon.com/cli/
.. _Cloud-Init: http://cloudinit.readthedocs.org/en/latest/
.. _Amazon Linux Ami: https://aws.amazon.com/amazon-linux-ami/
